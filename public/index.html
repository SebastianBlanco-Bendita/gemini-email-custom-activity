<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Email Custom Activity</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .config-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 20px;
            margin: 0 5px;
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .step.active {
            background: #007bff;
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .preview-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .ai-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }
        
        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-ready { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="config-container">
        <!-- Header -->
        <div class="text-center mb-4">
            <h2>ü§ñ Gemini Email Personalizado</h2>
            <p class="text-muted">Env√≠a emails personalizados usando IA de Google Gemini Pro</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1-indicator">
                <strong>1. Template</strong><br>
                <small>Configurar tipo de email</small>
            </div>
            <div class="step" id="step2-indicator">
                <strong>2. Opciones</strong><br>
                <small>Personalizaci√≥n avanzada</small>
            </div>
        </div>

        <!-- Step 1: Template Configuration -->
        <div id="step1" class="step-content">
            <h4>üé® Configuraci√≥n del Template</h4>
            
            <div class="form-group">
                <label for="emailTemplate" class="form-label">Tipo de Email:</label>
                <select class="form-select" id="emailTemplate">
                    <option value="default">Personalizado General</option>
                    <option value="promotional">Promocional</option>
                    <option value="informational">Informativo</option>
                    <option value="welcome">Bienvenida</option>
                </select>
                <div class="form-text">Selecciona el tipo de email que mejor se adapte a tu campa√±a</div>
            </div>

            <div class="feature-card">
                <h6>‚ú® Caracter√≠sticas del Email con IA:</h6>
                <ul class="mb-0">
                    <li>Contenido personalizado para cada contacto</li>
                    <li>Menciona la ciudad del contacto naturalmente</li>
                    <li>Adapta el mensaje a la categor√≠a de inter√©s</li>
                    <li>Genera asuntos atractivos autom√°ticamente</li>
                    <li>Tono profesional pero cercano</li>
                </ul>
            </div>

            <div class="preview-area">
                <h6>Vista previa del tipo de email:</h6>
                <div id="templatePreview">
                    <strong>Email Personalizado General</strong><br>
                    <small class="text-muted">Se adaptar√° autom√°ticamente a cada contacto usando sus datos: nombre, ciudad y categor√≠a de inter√©s.</small>
                </div>
            </div>
        </div>

        <!-- Step 2: Advanced Options -->
        <div id="step2" class="step-content d-none">
            <h4>‚öôÔ∏è Opciones Avanzadas</h4>
            
            <div class="form-group">
                <label for="customSubject" class="form-label">Asunto Personalizado (Opcional):</label>
                <input type="text" class="form-control" id="customSubject" 
                       placeholder="Deja vac√≠o para que IA genere el asunto autom√°ticamente">
                <div class="form-text">Si no especificas un asunto, Gemini crear√° uno personalizado para cada contacto</div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="feature-card">
                        <h6>üìä Datos Disponibles:</h6>
                        <ul class="mb-0">
                            <li>ContactKey</li>
                            <li>FirstName</li>
                            <li>City</li>
                            <li>InterestCategory</li>
                            <li>Mail</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="feature-card">
                        <h6>üîß Configuraci√≥n:</h6>
                        <div class="mb-2">
                            <span class="status-indicator status-ready"></span>
                            Data Extension: TestCustomActivity
                        </div>
                        <div class="mb-2">
                            <span class="status-indicator status-ready"></span>
                            IA Engine: Google Gemini Pro
                        </div>
                        <div class="mb-2">
                            <span class="status-indicator status-ready"></span>
                            Personalizaci√≥n: Activada
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <strong>üí° Consejo:</strong> Esta actividad tomar√° autom√°ticamente los datos de tu Data Extension "TestCustomActivity" 
                y generar√° contenido √∫nico para cada contacto usando IA.
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">
                ‚Üê Anterior
            </button>
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                Siguiente ‚Üí
            </button>
            <button type="button" class="btn btn-success" id="saveBtn" onclick="saveConfiguration()" style="display: none;">
                üíæ Guardar Configuraci√≥n
            </button>
        </div>

        <!-- Status Messages -->
        <div id="statusMessages" class="mt-3"></div>
    </div>

    <!-- Marketing Cloud SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/postmonger@1.3.15/postmonger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales
        let connection = new Postmonger.Session();
        let currentStep = 1;
        let payload = {};
        let activityData = {
            emailTemplate: 'default',
            subject: null
        };

        // Configuraci√≥n inicial
        connection.on('initActivity', function (data) {
            console.log('Activity initialized:', data);
            payload = data;
            
            // Si hay datos guardados, cargarlos
            if (data.arguments && data.arguments.execute && data.arguments.execute.inArguments) {
                const args = data.arguments.execute.inArguments[0];
                if (args.emailTemplate) {
                    document.getElementById('emailTemplate').value = args.emailTemplate;
                    activityData.emailTemplate = args.emailTemplate;
                    updateTemplatePreview();
                }
                if (args.subject) {
                    document.getElementById('customSubject').value = args.subject;
                    activityData.subject = args.subject;
                }
            }
            
            // Marcar como configurada
            connection.trigger('ready');
        });

        // Eventos de navegaci√≥n
        connection.on('clickedNext', function () {
            nextStep();
        });

        connection.on('clickedBack', function () {
            previousStep();
        });

        // Funciones de navegaci√≥n
        function nextStep() {
            if (currentStep === 1) {
                // Validar y pasar al step 2
                activityData.emailTemplate = document.getElementById('emailTemplate').value;
                
                showStep(2);
                currentStep = 2;
                
                document.getElementById('prevBtn').style.display = 'inline-block';
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('saveBtn').style.display = 'inline-block';
            }
        }

        function previousStep() {
            if (currentStep === 2) {
                showStep(1);
                currentStep = 1;
                
                document.getElementById('prevBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'inline-block';
                document.getElementById('saveBtn').style.display = 'none';
            }
        }

        function showStep(step) {
            // Ocultar todos los steps
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.add('d-none');
            });
            
            // Remover clase active de indicators
            document.querySelectorAll('.step').forEach(el => {
                el.classList.remove('active');
            });
            
            // Mostrar step actual
            document.getElementById(`step${step}`).classList.remove('d-none');
            document.getElementById(`step${step}-indicator`).classList.add('active');
        }

        function updateTemplatePreview() {
            const template = document.getElementById('emailTemplate').value;
            const preview = document.getElementById('templatePreview');
            
            const descriptions = {
                'default': '<strong>Email Personalizado General</strong><br><small class="text-muted">Contenido adaptado a cada contacto con tono profesional y amigable.</small>',
                'promotional': '<strong>Email Promocional</strong><br><small class="text-muted">Incluye ofertas relevantes y llamadas a la acci√≥n basadas en intereses.</small>',
                'informational': '<strong>Email Informativo</strong><br><small class="text-muted">Comparte conocimiento valioso relacionado con la categor√≠a de inter√©s.</small>',
                'welcome': '<strong>Email de Bienvenida</strong><br><small class="text-muted">Saludo c√°lido y orientaci√≥n para nuevos contactos.</small>'
            };
            
            preview.innerHTML = descriptions[template] || descriptions['default'];
        }

        function saveConfiguration() {
            // Recoger datos del formulario
            activityData.emailTemplate = document.getElementById('emailTemplate').value;
            activityData.subject = document.getElementById('customSubject').value || null;
            
            // Configurar argumentos para Marketing Cloud
            const configData = {
                arguments: {
                    execute: {
                        inArguments: [
                            {
                                ContactKey: "{{Contact.Key}}",
                                Mail: "{{InteractionDefaults.Email}}",
                                FirstName: "{{Contact.Attribute.TestCustomActivity.FirstName}}",
                                City: "{{Contact.Attribute.TestCustomActivity.City}}",
                                InterestCategory: "{{Contact.Attribute.TestCustomActivity.InterestCategory}}",
                                emailTemplate: activityData.emailTemplate,
                                subject: activityData.subject
                            }
                        ],
                        outArguments: []
                    }
                },
                metaData: {
                    isConfigured: true
                }
            };
            
            console.log('Saving configuration:', configData);
            
            // Mostrar mensaje de guardado
            showStatus('Configuraci√≥n guardada exitosamente', 'success');
            
            // Enviar configuraci√≥n a Marketing Cloud
            connection.trigger('updateActivity', configData);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessages');
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
            
            statusDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // Event listeners
        document.getElementById('emailTemplate').addEventListener('change', updateTemplatePreview);
        
        // Inicializar
        updateTemplatePreview();

        // Validaci√≥n en tiempo real
        document.getElementById('customSubject').addEventListener('input', function() {
            const value = this.value;
            if (value.length > 50) {
                this.classList.add('is-invalid');
                showStatus('El asunto no debe exceder 50 caracteres', 'error');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    </script>
</body>
</html>
